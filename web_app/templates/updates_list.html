{% extends 'base.html' %}
{% block content %}
<h2>Padėties atnaujinimai</h2>
<a href="/updates/add">Pridėti naują</a>
<table id="updates-table" class="display" style="width:100%">
    <thead>
        <tr>
            <th>ID</th>
            <th>Vilkikas</th>
            <th>Data</th>
            <th>SA</th>
            <th>Darbo laikas</th>
            <th>Likusios val.</th>
            <th>P. data</th>
            <th>P. laikas</th>
            <th>P. statusas</th>
            <th>I. data</th>
            <th>I. laikas</th>
            <th>I. statusas</th>
            <th>Komentaras</th>
            <th>Atnaujinta prieš</th>
            <th>Veiksmai</th>
        </tr>
    </thead>
</table>
<script>
$(document).ready(function() {
    $('#updates-table').DataTable({
        ajax: '/api/updates',
        columns: [
            { data: 'id' },
            { data: 'vilkiko_numeris' },
            { data: 'data' },
            { data: 'sa' },
            { data: 'darbo_laikas' },
            { data: 'likes_laikas' },
            { data: 'pakrovimo_data' },
            { data: 'pakrovimo_laikas', render: function(d){return formatTime(d);} },
            { data: 'pakrovimo_statusas' },
            { data: 'iskrovimo_data' },
            { data: 'iskrovimo_laikas', render: function(d){return formatTime(d);} },
            { data: 'iskrovimo_statusas' },
            { data: 'komentaras' },
            { data: 'created_at', render: function(d){return relativeTime(d);} },
            { data: null, render: function(data, type, row) {
                return '<a href="/updates/' + row.id + '/edit">Edit</a>';
            }}
        ]
    });
});

function formatTime(val) {
    if (!val) return '';
    var digits = String(val).replace(/\D/g, '');
    if (digits.length === 1) return '0' + digits + ':00';
    if (digits.length === 2) return digits.padStart(2, '0') + ':00';
    if (digits.length === 3) return '0' + digits[0] + ':' + digits.slice(1).padStart(2, '0');
    if (digits.length === 4) return digits.slice(0, 2) + ':' + digits.slice(2);
    return val;
}

function relativeTime(ts) {
    if (!ts) return '';
    var created = new Date(ts);
    var now = new Date();
    var diff = Math.floor((now - created) / 60000);
    var hrs = String(Math.floor(diff / 60)).padStart(2, '0');
    var mins = String(diff % 60).padStart(2, '0');
    return hrs + ':' + mins;
}
</script>
{% endblock %}
