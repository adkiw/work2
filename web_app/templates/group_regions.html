{% extends 'base.html' %}
{% from 'macros.html' import header_with_add %}
{% block content %}
{{ header_with_add('Grupių regionai') }}
<div class="group-select">
    <label>Grupė:
        <select id="grupe-select"></select>
    </label>
</div>
<table id="region-table" class="display" style="width:100%; margin-top:10px;">
    <thead>
        <tr>
            <th>ID</th>
            <th>Regiono kodas</th>
            <th>Kitos grupės</th>
            <th>Vadybininkas</th>
            <th>Veiksmai</th>
        </tr>
    </thead>
</table>
<div id="map" style="height:400px; margin-top:10px;"></div>
<form id="add-form" style="margin-top:10px;">
    <input type="hidden" name="grupe_id" id="grupe-id-input">
    <label>Nauji regionai (pvz. FR10;DE20)</label>
    <textarea name="regionai" id="regionai" rows="2" style="width:100%;"></textarea>
    <button type="submit">Pridėti</button>
</form>
<link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
$(document).ready(function() {
    let table;
    const selected = new Set();
    const map = L.map('map').setView([55.2, 23.9], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 10,
        attribution: '© OpenStreetMap'
    }).addTo(map);
    function updateField(){
        $('#regionai').val(Array.from(selected).join(';'));
    }
        fetch('/static/nuts_regions.geojson')
            .then(r => r.json())
            .then(data => {
                L.geoJSON(data, {
                    onEachFeature: function(feature, layer){
                        const code = feature.properties.NUTS_ID ||
                                     feature.properties.PCODE ||
                                     feature.properties.id;
                        if(!code) return;
                    layer.on('click', function(){
                        if(selected.has(code)){
                            selected.delete(code);
                            layer.setStyle({fillColor: '#3388ff'});
                        } else {
                            selected.add(code);
                            layer.setStyle({fillColor: '#00ff00'});
                        }
                        updateField();
                    });
                    layer.bindTooltip(code, {permanent: true, direction:'center', className:'region-label'});
                },
                style:{color:'#3388ff',weight:1,fillOpacity:0.4}
            }).addTo(map);
        });
    function initTable(){
        table = $('#region-table').DataTable({
            ajax: {
                url: '/api/group-regions',
                data: function(d){ d.gid = $('#grupe-select').val(); }
            },
            columns: [
                { data: 'id' },
                { data: 'regiono_kodas' },
                { data: 'kitos_grupes', defaultContent: '' },
                { data: 'vadybininkas', defaultContent: '' },
                { data: null, render: function(data,type,row){
                    const gid = $('#grupe-select').val();
                    return `<a href="/group-regions/${row.id}/delete?gid=${gid}">Šalinti</a>`;
                }}
            ]
        });
    }
    async function loadGroups(){
        const resp = await fetch('/api/grupes');
        const data = await resp.json();
        const sel = $('#grupe-select');
        sel.empty();
        data.data.forEach(g => sel.append(`<option value="${g.id}">${g.numeris}</option>`));
        $('#grupe-id-input').val(sel.val());
        if(!table){
            initTable();
        } else {
            table.ajax.reload();
        }
    }
    $('#grupe-select').on('change', function(){
        $('#grupe-id-input').val($(this).val());
        table.ajax.reload();
    });
    $('#add-form').on('submit', async function(e){
        e.preventDefault();
        const formData = $(this).serialize();
        const resp = await fetch('/group-regions/add', {
            method:'POST',
            headers:{'Content-Type':'application/x-www-form-urlencoded'},
            body:formData
        });
        if(resp.redirected){
            table.ajax.reload();
            $('#regionai').val('');
        }
    });
    loadGroups();
});
</script>
<style>
.page-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.group-select { margin-bottom:10px; }
</style>
{% endblock %}
