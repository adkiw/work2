{% extends 'base.html' %}
{% from 'macros.html' import header_with_add %}
{% block content %}
{{ header_with_add('Grupių regionai') }}
<div class="group-select">
    <label>Grupė:
        <select id="grupe-select"></select>
    </label>
</div>
<table id="region-table" class="display" style="width:100%; margin-top:10px;">
    <thead>
        <tr>
            <th>ID</th>
            <th>Regiono kodas</th>
            <th>Kitos grupės</th>
            <th>Vadybininkas</th>
            <th>Veiksmai</th>
        </tr>
    </thead>
</table>
<form id="add-form" style="margin-top:10px;">
    <input type="hidden" name="grupe_id" id="grupe-id-input">
    <label>Nauji regionai (pvz. FR10;DE20)</label>
    <textarea name="regionai" id="regionai" rows="2" style="width:100%;"></textarea>
    <label>Vadybininkas
        <select name="vadybininkas_id" id="vadybininkas-select"></select>
    </label>
    <button type="submit">Pridėti</button>
</form>
<script>
$(document).ready(function() {
    let table;
    let employees = [];
    function initTable(){
        table = $('#region-table').DataTable({
            ajax: {
                url: '/api/group-regions',
                data: function(d){ d.gid = $('#grupe-select').val(); }
            },
            columns: [
                { data: 'id' },
                { data: 'regiono_kodas' },
                { data: 'kitos_grupes', defaultContent: '' },
                { data: null, render: function(data,type,row){
                    let options = '<option value="">--</option>';
                    employees.forEach(e => {
                        const sel = e.id === row.vadybininkas_id ? 'selected' : '';
                        options += `<option value="${e.id}" ${sel}>${e.vardas} ${e.pavarde}</option>`;
                    });
                    return `<select class="vadyb-select" data-rid="${row.id}">${options}</select>`;
                }},
                { data: null, render: function(data,type,row){
                    const gid = $('#grupe-select').val();
                    return `<a href="/group-regions/${row.id}/delete?gid=${gid}">Šalinti</a>`;
                }}
            ]
        });
    }
    async function loadEmployees(){
        const resp = await fetch('/api/darbuotojai');
        const data = await resp.json();
        employees = data.data;
        const sel = $('#vadybininkas-select');
        sel.empty();
        sel.append('<option value="">--</option>');
        employees.forEach(e => sel.append(`<option value="${e.id}">${e.vardas} ${e.pavarde}</option>`));
    }
    async function loadGroups(){
        const resp = await fetch('/api/grupes');
        const data = await resp.json();
        const sel = $('#grupe-select');
        sel.empty();
        data.data.forEach(g => sel.append(`<option value="${g.id}">${g.numeris}</option>`));
        $('#grupe-id-input').val(sel.val());
        if(!table){
            initTable();
        } else {
            table.ajax.reload();
        }
    }
    $('#grupe-select').on('change', function(){
        $('#grupe-id-input').val($(this).val());
        table.ajax.reload();
    });
    $('#add-form').on('submit', async function(e){
        e.preventDefault();
        const formData = $(this).serialize();
        const resp = await fetch('/group-regions/add', {
            method:'POST',
            headers:{'Content-Type':'application/x-www-form-urlencoded'},
            body:formData
        });
        if(resp.redirected){
            table.ajax.reload();
            $('#regionai').val('');
        }
    });
    loadEmployees().then(loadGroups);

    $(document).on('change', '.vadyb-select', async function(){
        const rid = $(this).data('rid');
        const gid = $('#grupe-select').val();
        const vid = $(this).val();
        const body = `vadybininkas_id=${vid}&gid=${gid}`;
        await fetch(`/group-regions/${rid}/assign`, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body});
        table.ajax.reload(null,false);
    });
});
</script>
<style>
.page-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.group-select { margin-bottom:10px; }
</style>
{% endblock %}
